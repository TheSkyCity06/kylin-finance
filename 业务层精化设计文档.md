# 4. ä¸šåŠ¡å±‚ç²¾åŒ–è®¾è®¡

## 4.1 ä¸šåŠ¡å±‚æ€»ä½“æ¶æ„

### 4.1.1 æ¶æ„å®šä½

ä¸šåŠ¡å±‚ï¼ˆService Layerï¼‰ä½äºè¡¨ç°å±‚ï¼ˆControllerï¼‰ä¸æ•°æ®è®¿é—®å±‚ï¼ˆMapperï¼‰ä¹‹é—´ï¼Œæ‰¿æ‹…æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å¤„ç†èŒè´£ã€‚æœ¬ç³»ç»Ÿé‡‡ç”¨**æ¥å£-å®ç°åˆ†ç¦»**çš„è®¾è®¡æ¨¡å¼ï¼Œé€šè¿‡æ¥å£å®šä¹‰ä¸šåŠ¡å¥‘çº¦ï¼Œå®ç°ç±»å®Œæˆå…·ä½“ä¸šåŠ¡é€»è¾‘ï¼Œå®ç°äº†è‰¯å¥½çš„è§£è€¦å’Œå¯æ‰©å±•æ€§ã€‚

ä¸šåŠ¡å±‚ä¸»è¦èŒè´£åŒ…æ‹¬ï¼š
- **ä¸šåŠ¡è§„åˆ™æ ¡éªŒ**ï¼šå‡­è¯å€Ÿè´·å¹³è¡¡ã€ç§‘ç›®æœ«çº§æ ¡éªŒã€ä½™é¢æ–¹å‘æ ¡éªŒç­‰
- **ä¸šåŠ¡æµç¨‹ç¼–æ’**ï¼šå‡­è¯å½•å…¥ã€å®¡æ ¸ã€è¿‡è´¦ç­‰å¤æ‚ä¸šåŠ¡æµç¨‹çš„åè°ƒ
- **æ•°æ®è½¬æ¢**ï¼šEntity ä¸ DTO ä¹‹é—´çš„åŒå‘è½¬æ¢
- **äº‹åŠ¡ç®¡ç†**ï¼šç¡®ä¿ä¸šåŠ¡æ“ä½œçš„åŸå­æ€§å’Œä¸€è‡´æ€§
- **å¼‚å¸¸å¤„ç†**ï¼šç»Ÿä¸€çš„ä¸šåŠ¡å¼‚å¸¸æŠ›å‡ºæœºåˆ¶

### 4.1.2 æ ¸å¿ƒ Service æ¶æ„å›¾

```mermaid
classDiagram
    class IFinTransactionService {
        <<interface>>
        +saveVoucher(FinTransaction)
        +updateVoucher(FinTransaction)
        +deleteVoucher(Long)
        +auditVoucher(Long)
        +queryVouchers(VoucherQueryDTO)
        +getVoucherById(Long)
        +generateVoucherNo()
    }
    
    class TransactionServiceImpl {
        -FinSplitMapper splitMapper
        -FinAccountMapper accountMapper
        -IFinAccountService accountService
        -IAccountingService accountingService
        -IOwnerValidationService ownerValidationService
        +saveVoucher(FinTransaction)
        +updateVoucher(FinTransaction)
        +deleteVoucher(Long)
        +auditVoucher(Long)
        -validateLeafAccounts(List~FinSplit~)
        -validateDebitCreditBalance(List~FinSplit~)
        -validateAccountDirectionCombination(List~FinSplit~)
        -validateBalanceDirection(List~FinSplit~, LocalDate)
    }
    
    class IFinAccountService {
        <<interface>>
        +getAccountTree()
        +getChildrenByParentId(Long)
        +addAccount(FinAccount)
        +updateAccount(FinAccount)
        +deleteAccount(Long)
        +isLeafAccount(Long)
        +getLeafAccounts()
        +getAccountPath(Long)
    }
    
    class FinAccountServiceImpl {
        -FinSplitMapper splitMapper
        +getAccountTree()
        +buildTree(List~AccountDTO~, Long)
        +setTreeProperties(List~AccountDTO~, List~AccountDTO~, String)
        +addAccount(FinAccount)
        +updateAccount(FinAccount)
        +deleteAccount(Long)
    }
    
    class IAccountingService {
        <<interface>>
        +calculateAccountBalance(Long, LocalDate)
        +calculateAllAccountBalances(LocalDate)
        +generateTrialBalance(LocalDate, LocalDate)
        +verifyTrialBalance(LocalDate)
    }
    
    class AccountingServiceImpl {
        -FinAccountMapper accountMapper
        -FinSplitMapper splitMapper
        +calculateAccountBalance(Long, LocalDate)
        +calculateAllAccountBalances(LocalDate)
        +generateTrialBalance(LocalDate, LocalDate)
        +verifyTrialBalance(LocalDate)
        -calculateBalanceByType(String, BigDecimal, BigDecimal)
    }
    
    class IReportService {
        <<interface>>
        +generateBalanceSheet(LocalDate)
        +generateCashFlowStatement(LocalDate, LocalDate)
        +generateBalanceSheetExportData(LocalDate)
        +generateTrialBalanceExportData(LocalDate, LocalDate)
        +generateCashFlowExportData(LocalDate, LocalDate)
    }
    
    class ReportServiceImpl {
        -FinAccountMapper accountMapper
        -FinTransactionMapper transactionMapper
        -FinSplitMapper splitMapper
        -IAccountingService accountingService
        +generateBalanceSheet(LocalDate)
        +generateCashFlowStatement(LocalDate, LocalDate)
        -calculateBalanceByType(String, BigDecimal, BigDecimal)
    }
    
    class IBizExpenseClaimService {
        <<interface>>
        +getById(Long)
        +getClaimList(Page, String, String, String, String)
        +getDetailsByClaimId(Long)
        +saveExpenseClaim(BizExpenseClaim)
        +updateExpenseClaim(BizExpenseClaim)
        +saveAndPostExpenseClaim(BizExpenseClaim)
        +postExpenseClaim(Long)
    }
    
    class BizExpenseClaimServiceImpl {
        -BizExpenseClaimMapper claimMapper
        -BizExpenseClaimDetailMapper detailMapper
        -IFinTransactionService transactionService
        -IFinAccountService accountService
        +saveExpenseClaim(BizExpenseClaim)
        +updateExpenseClaim(BizExpenseClaim)
        +postExpenseClaim(Long)
        -validateExpenseClaim(BizExpenseClaim)
        -validateAccountsForPosting(BizExpenseClaim)
        -generateClaimNo()
        -updateAccountBalances(List~FinSplit~, LocalDate)
    }
    
    class IOwnerValidationService {
        <<interface>>
        +validateOwnerAssociation(List~FinSplit~)
        +validateSplitOwnerAssociation(FinSplit)
    }
    
    class OwnerValidationServiceImpl {
        -OwnerMapper ownerMapper
        +validateOwnerAssociation(List~FinSplit~)
        +validateSplitOwnerAssociation(FinSplit)
        -findOwnerById(Long, String)
    }
    
    IFinTransactionService <|.. TransactionServiceImpl
    IFinAccountService <|.. FinAccountServiceImpl
    IAccountingService <|.. AccountingServiceImpl
    IReportService <|.. ReportServiceImpl
    IBizExpenseClaimService <|.. BizExpenseClaimServiceImpl
    IOwnerValidationService <|.. OwnerValidationServiceImpl
    
    TransactionServiceImpl --> IFinAccountService
    TransactionServiceImpl --> IAccountingService
    TransactionServiceImpl --> IOwnerValidationService
    ReportServiceImpl --> IAccountingService
    BizExpenseClaimServiceImpl --> IFinTransactionService
    BizExpenseClaimServiceImpl --> IFinAccountService
```

### 4.1.3 æœåŠ¡åˆ†å±‚è¯´æ˜

**æ ¸å¿ƒè´¢åŠ¡æœåŠ¡å±‚**ï¼š
- `IFinTransactionService`ï¼šå‡­è¯ç®¡ç†æ ¸å¿ƒæœåŠ¡ï¼Œè´Ÿè´£å‡­è¯çš„ CRUD åŠå®¡æ ¸æµç¨‹
- `IFinAccountService`ï¼šç§‘ç›®ç®¡ç†æœåŠ¡ï¼Œæä¾›ç§‘ç›®æ ‘æ„å»ºã€æœ«çº§ç§‘ç›®åˆ¤æ–­ç­‰åŠŸèƒ½
- `IAccountingService`ï¼šæ ¸ç®—æœåŠ¡ï¼Œè´Ÿè´£ä½™é¢è®¡ç®—ã€è¯•ç®—å¹³è¡¡ç­‰æ ¸ç®—åŠŸèƒ½

**ä¸šåŠ¡å•æ®æœåŠ¡å±‚**ï¼š
- `IBizExpenseClaimService`ï¼šæŠ¥é”€å•æœåŠ¡ï¼Œå¤„ç†æŠ¥é”€å•çš„ä¿å­˜ã€è¿‡è´¦ç­‰ä¸šåŠ¡
- `IBizReceiptPaymentService`ï¼šæ”¶ä»˜æ¬¾å•æœåŠ¡ï¼Œå¤„ç†æ”¶ä»˜æ¬¾ä¸šåŠ¡

**æŠ¥è¡¨æœåŠ¡å±‚**ï¼š
- `IReportService`ï¼šæŠ¥è¡¨ç”ŸæˆæœåŠ¡ï¼Œç”Ÿæˆèµ„äº§è´Ÿå€ºè¡¨ã€ç°é‡‘æµé‡è¡¨ç­‰è´¢åŠ¡æŠ¥è¡¨

**è¾…åŠ©æœåŠ¡å±‚**ï¼š
- `IOwnerValidationService`ï¼šä¸šåŠ¡å®ä½“æ ¡éªŒæœåŠ¡ï¼Œç¡®ä¿å‡­è¯åˆ†å½•ä¸ä¸šåŠ¡å®ä½“çš„å…³è”æ­£ç¡®æ€§

## 4.2 æ ¸å¿ƒä¸šåŠ¡æµç¨‹ç²¾åŒ–

### 4.2.1 å‡­è¯å½•å…¥æµç¨‹

å‡­è¯å½•å…¥æ˜¯è´¢åŠ¡ç³»ç»Ÿçš„æ ¸å¿ƒä¸šåŠ¡æµç¨‹ï¼Œæ¶‰åŠå¤šå±‚æ¬¡çš„ä¸šåŠ¡è§„åˆ™æ ¡éªŒå’Œæ•°æ®ä¸€è‡´æ€§ä¿éšœã€‚

#### 4.2.1.1 æµç¨‹æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant Controller as æ§åˆ¶å™¨å±‚
    participant TransactionService as TransactionServiceImpl
    participant AccountService as FinAccountServiceImpl
    participant AccountingService as AccountingServiceImpl
    participant OwnerValidationService as OwnerValidationServiceImpl
    participant TransactionMapper as FinTransactionMapper
    participant SplitMapper as FinSplitMapper
    
    Controller->>TransactionService: saveVoucher(FinTransaction)
    
    Note over TransactionService: 1. åŸºç¡€æ ¡éªŒ
    TransactionService->>TransactionService: æ ¡éªŒåˆ†å½•æ•°é‡ >= 2
    
    Note over TransactionService: 2. æœ«çº§ç§‘ç›®æ ¡éªŒ
    TransactionService->>AccountService: isLeafAccount(accountId)
    AccountService-->>TransactionService: true/false
    alt éæœ«çº§ç§‘ç›®
        TransactionService-->>Controller: BusinessException("ä¸æ˜¯æœ«çº§ç§‘ç›®")
    end
    
    Note over TransactionService: 3. å€Ÿè´·å¹³è¡¡æ ¡éªŒ
    TransactionService->>TransactionService: validateDebitCreditBalance()
    alt å€Ÿè´·ä¸å¹³è¡¡
        TransactionService-->>Controller: BusinessException("å€Ÿè´·ä¸å¹³")
    end
    
    Note over TransactionService: 4. ç§‘ç›®æ–¹å‘ç»„åˆæ ¡éªŒ
    TransactionService->>TransactionService: validateAccountDirectionCombination()
    
    Note over TransactionService: 5. ä½™é¢æ–¹å‘æ ¡éªŒ
    TransactionService->>AccountingService: calculateAccountBalance(accountId, date)
    AccountingService-->>TransactionService: AccountBalanceDTO
    TransactionService->>TransactionService: validateBalanceDirection()
    alt ä½™é¢å°†å˜ä¸ºè´Ÿæ•°ï¼ˆèµ„äº§ç±»ï¼‰
        TransactionService-->>Controller: BusinessException("ä½™é¢å°†å˜ä¸ºè´Ÿæ•°")
    end
    
    Note over TransactionService: 6. ä¸šåŠ¡å®ä½“å…³è”æ ¡éªŒ
    TransactionService->>OwnerValidationService: validateOwnerAssociation(splits)
    OwnerValidationService->>OwnerValidationService: validateSplitOwnerAssociation()
    alt ä¸šåŠ¡å®ä½“å…³è”é”™è¯¯
        OwnerValidationService-->>TransactionService: BusinessException("ä¸šåŠ¡å®ä½“å…³è”é”™è¯¯")
    end
    
    Note over TransactionService: 7. ç”Ÿæˆå‡­è¯å·
    TransactionService->>TransactionMapper: æŸ¥è¯¢å½“å¤©æœ€å¤§å‡­è¯å·
    TransactionMapper-->>TransactionService: FinTransaction
    TransactionService->>TransactionService: generateVoucherNo()
    
    Note over TransactionService: 8. è®¾ç½®é»˜è®¤å€¼
    TransactionService->>TransactionService: è®¾ç½®çŠ¶æ€=0(è‰ç¨¿)
    TransactionService->>TransactionService: è®¾ç½®å½•å…¥æ—¶é—´=now()
    
    Note over TransactionService: 9. æ•°æ®æŒä¹…åŒ–ï¼ˆäº‹åŠ¡ï¼‰
    TransactionService->>TransactionMapper: save(transaction)
    TransactionMapper-->>TransactionService: transId
    loop éå†æ¯æ¡åˆ†å½•
        TransactionService->>SplitMapper: insert(split)
    end
    
    TransactionService-->>Controller: æˆåŠŸ
```

#### 4.2.1.2 ä¸šåŠ¡è§„åˆ™è¯¦è§£

**è§„åˆ™1ï¼šåˆ†å½•æ•°é‡æ ¡éªŒ**
- **è§„åˆ™**ï¼šå‡­è¯è‡³å°‘éœ€è¦ä¸€å€Ÿä¸€è´·ä¸¤æ¡åˆ†å½•
- **å®ç°ä½ç½®**ï¼š`TransactionServiceImpl.saveVoucher()` ç¬¬49è¡Œ
- **å¼‚å¸¸**ï¼š`BusinessException("å‡­è¯è‡³å°‘éœ€è¦ä¸€å€Ÿä¸€è´·ä¸¤æ¡åˆ†å½•")`

**è§„åˆ™2ï¼šæœ«çº§ç§‘ç›®æ ¡éªŒ**
- **è§„åˆ™**ï¼šå‡­è¯åˆ†å½•åªèƒ½ä½¿ç”¨æœ«çº§ç§‘ç›®ï¼ˆæ²¡æœ‰å­ç§‘ç›®çš„ç§‘ç›®ï¼‰
- **å®ç°ä½ç½®**ï¼š`TransactionServiceImpl.validateLeafAccounts()` ç¬¬264-277è¡Œ
- **æ ¡éªŒé€»è¾‘**ï¼šéå†æ‰€æœ‰åˆ†å½•ï¼Œè°ƒç”¨ `accountService.isLeafAccount()` åˆ¤æ–­
- **å¼‚å¸¸**ï¼š`BusinessException("å‡­è¯åˆ†å½•åªèƒ½ä½¿ç”¨æœ«çº§ç§‘ç›®ï¼Œç§‘ç›®\"XXX\"ä¸æ˜¯æœ«çº§ç§‘ç›®")`

**è§„åˆ™3ï¼šå€Ÿè´·å¹³è¡¡æ ¡éªŒ**
- **è§„åˆ™**ï¼šå€Ÿæ–¹é‡‘é¢æ€»å’Œå¿…é¡»ç­‰äºè´·æ–¹é‡‘é¢æ€»å’Œ
- **å®ç°ä½ç½®**ï¼š`TransactionServiceImpl.validateDebitCreditBalance()` ç¬¬282-304è¡Œ
- **è®¡ç®—é€»è¾‘**ï¼š
  ```java
  BigDecimal debits = æ‰€æœ‰DEBITæ–¹å‘åˆ†å½•é‡‘é¢ä¹‹å’Œ
  BigDecimal credits = æ‰€æœ‰CREDITæ–¹å‘åˆ†å½•é‡‘é¢ä¹‹å’Œ
  æ ¡éªŒï¼šdebits.compareTo(credits) == 0
  ```
- **å¼‚å¸¸**ï¼š`BusinessException("å€Ÿè´·ä¸å¹³ï¼å€Ÿæ–¹ï¼šXï¼Œè´·æ–¹ï¼šYï¼Œå·®å¼‚ï¼šZ")`

**è§„åˆ™4ï¼šç§‘ç›®æ–¹å‘ç»„åˆæ ¡éªŒ**
- **è§„åˆ™**ï¼šæ£€æŸ¥ç§‘ç›®æ–¹å‘ç»„åˆçš„åˆç†æ€§ï¼ˆå¦‚ç°é‡‘å€Ÿæ–¹ä¸é•¿æœŸè´Ÿå€ºè´·æ–¹çš„ç»„åˆï¼‰
- **å®ç°ä½ç½®**ï¼š`TransactionServiceImpl.validateAccountDirectionCombination()` ç¬¬309-340è¡Œ
- **è¯´æ˜**ï¼šå½“å‰å®ç°ä¸ºè­¦å‘Šçº§åˆ«ï¼Œä¸é˜»æ­¢ä¿å­˜ï¼Œä½†ä¸ºåç»­ä¸šåŠ¡è§„åˆ™æ‰©å±•é¢„ç•™æ¥å£

**è§„åˆ™5ï¼šä½™é¢æ–¹å‘æ ¡éªŒ**
- **è§„åˆ™**ï¼šèµ„äº§ç±»ç§‘ç›®ä½™é¢ä¸èƒ½ä¸ºè´Ÿæ•°ï¼ˆé™¤éæ˜¯é“¶è¡Œé€æ”¯ç­‰ç‰¹æ®Šæƒ…å†µï¼‰
- **å®ç°ä½ç½®**ï¼š`TransactionServiceImpl.validateBalanceDirection()` ç¬¬345-408è¡Œ
- **è®¡ç®—é€»è¾‘**ï¼š
  - èµ„äº§/è´¹ç”¨ç±»ï¼šä½™é¢ = å€Ÿæ–¹ - è´·æ–¹
  - è´Ÿå€º/æƒç›Š/æ”¶å…¥ç±»ï¼šä½™é¢ = è´·æ–¹ - å€Ÿæ–¹
  - è®¡ç®—æ–°ä½™é¢åï¼Œæ£€æŸ¥èµ„äº§ç±»ç§‘ç›®æ˜¯å¦å˜ä¸ºè´Ÿæ•°
- **å¼‚å¸¸**ï¼š`BusinessException("ç§‘ç›®\"XXX\"ä½™é¢å°†å˜ä¸ºè´Ÿæ•°ï¼ˆå½“å‰ä½™é¢ï¼šXï¼Œå½•å…¥åä½™é¢ï¼šYï¼‰")`

**è§„åˆ™6ï¼šä¸šåŠ¡å®ä½“å…³è”æ ¡éªŒ**
- **è§„åˆ™**ï¼šå¦‚æœåˆ†å½•å…³è”äº†ä¸šåŠ¡å®ä½“ï¼ˆå®¢æˆ·ã€ä¾›åº”å•†ã€å‘˜å·¥ï¼‰ï¼Œå¿…é¡»ç¡®ä¿è¯¥å®ä½“åœ¨å¯¹åº”ç§‘ç›®ä¸‹æœ‰æ­£ç¡®çš„å…³è”å…³ç³»
- **å®ç°ä½ç½®**ï¼š`OwnerValidationServiceImpl.validateSplitOwnerAssociation()` ç¬¬35-55è¡Œ
- **æ ¡éªŒé€»è¾‘**ï¼š
  1. æ£€æŸ¥åˆ†å½•æ˜¯å¦æœ‰å…³è”ä¸šåŠ¡å®ä½“ï¼ˆownerIdã€ownerTypeï¼‰
  2. æŸ¥è¯¢ä¸šåŠ¡å®ä½“ä¿¡æ¯
  3. è°ƒç”¨å®ä½“çš„ `validateSplitAssociation()` æ–¹æ³•æ ¡éªŒ
- **å¼‚å¸¸**ï¼š`BusinessException("æœªæ‰¾åˆ°ä¸šåŠ¡å®ä½“"` æˆ– `"ä¸šåŠ¡å®ä½“ç±»å‹ä¸åŒ¹é…")`

### 4.2.2 æŠ¥é”€å•è¿‡è´¦æµç¨‹

æŠ¥é”€å•è¿‡è´¦æ˜¯å°†ä¸šåŠ¡å•æ®è½¬æ¢ä¸ºè´¢åŠ¡å‡­è¯çš„å…³é”®æµç¨‹ï¼Œä½“ç°äº†ä¸šåŠ¡å•æ®ä¸è´¢åŠ¡å‡­è¯çš„å…³è”å…³ç³»ã€‚

#### 4.2.2.1 æµç¨‹æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant Controller as æ§åˆ¶å™¨å±‚
    participant ExpenseClaimService as BizExpenseClaimServiceImpl
    participant TransactionService as IFinTransactionService
    participant AccountService as IFinAccountService
    participant ClaimMapper as BizExpenseClaimMapper
    participant DetailMapper as BizExpenseClaimDetailMapper
    participant TransactionMapper as FinTransactionMapper
    
    Controller->>ExpenseClaimService: postExpenseClaim(claimId)
    
    Note over ExpenseClaimService: 1. çŠ¶æ€æ ¡éªŒ
    ExpenseClaimService->>ClaimMapper: selectById(claimId)
    ClaimMapper-->>ExpenseClaimService: BizExpenseClaim
    alt çŠ¶æ€ != DRAFT
        ExpenseClaimService-->>Controller: BusinessException("çŠ¶æ€ä¸æ­£ç¡®")
    end
    
    Note over ExpenseClaimService: 2. è·å–æ˜ç»†
    ExpenseClaimService->>DetailMapper: selectList(claimId)
    DetailMapper-->>ExpenseClaimService: List~BizExpenseClaimDetail~
    ExpenseClaimService->>ExpenseClaimService: æ ¡éªŒæ€»é‡‘é¢ä¸æ˜ç»†é‡‘é¢ä¸€è‡´
    
    Note over ExpenseClaimService: 3. æ„å»ºå‡­è¯å¯¹è±¡
    ExpenseClaimService->>ExpenseClaimService: åˆ›å»º FinTransaction
    ExpenseClaimService->>ExpenseClaimService: è®¾ç½®å‡­è¯æ—¥æœŸã€æè¿°ã€çŠ¶æ€
    
    Note over ExpenseClaimService: 4. ç”Ÿæˆå€Ÿæ–¹åˆ†å½•ï¼ˆæ˜ç»†ï¼‰
    loop éå†æ¯æ¡æ˜ç»†
        ExpenseClaimService->>ExpenseClaimService: åˆ›å»º FinSplit(DEBIT)
        ExpenseClaimService->>ExpenseClaimService: è®¾ç½®ç§‘ç›®IDã€é‡‘é¢ã€æ‘˜è¦
    end
    
    Note over ExpenseClaimService: 5. ç”Ÿæˆè´·æ–¹åˆ†å½•ï¼ˆæ±‡æ€»ï¼‰
    ExpenseClaimService->>ExpenseClaimService: åˆ›å»º FinSplit(CREDIT)
    ExpenseClaimService->>ExpenseClaimService: è®¾ç½®ä»˜æ¬¾è´¦æˆ·ã€æ€»é‡‘é¢
    
    Note over ExpenseClaimService: 6. å€Ÿè´·å¹³è¡¡æ ¡éªŒ
    ExpenseClaimService->>ExpenseClaimService: è®¡ç®—å€Ÿæ–¹æ€»é¢
    ExpenseClaimService->>ExpenseClaimService: è®¡ç®—è´·æ–¹æ€»é¢
    alt å€Ÿè´·ä¸å¹³è¡¡
        ExpenseClaimService-->>Controller: BusinessException("å€Ÿè´·ä¸å¹³è¡¡")
    end
    
    Note over ExpenseClaimService: 7. ä¿å­˜å‡­è¯ï¼ˆè°ƒç”¨å‡­è¯æœåŠ¡ï¼‰
    ExpenseClaimService->>TransactionService: saveVoucher(voucher)
    Note over TransactionService: æ‰§è¡Œå‡­è¯çš„æ‰€æœ‰æ ¡éªŒé€»è¾‘
    TransactionService-->>ExpenseClaimService: æˆåŠŸ
    
    Note over ExpenseClaimService: 8. æ›´æ–°æŠ¥é”€å•çŠ¶æ€
    ExpenseClaimService->>ExpenseClaimService: è®¾ç½®çŠ¶æ€=POSTED
    ExpenseClaimService->>ExpenseClaimService: è®¾ç½®voucherId
    ExpenseClaimService->>ClaimMapper: updateById(claim)
    
    ExpenseClaimService-->>Controller: FinTransaction(å‡­è¯å¯¹è±¡)
```

#### 4.2.2.2 ä¸šåŠ¡è§„åˆ™è¯¦è§£

**è§„åˆ™1ï¼šçŠ¶æ€æµè½¬æ§åˆ¶**
- **è§„åˆ™**ï¼šåªæœ‰è‰ç¨¿çŠ¶æ€ï¼ˆDRAFTï¼‰çš„æŠ¥é”€å•æ‰èƒ½è¿‡è´¦
- **å®ç°ä½ç½®**ï¼š`BizExpenseClaimServiceImpl.postExpenseClaim()` ç¬¬279-288è¡Œ
- **çŠ¶æ€æµè½¬**ï¼š`DRAFT` â†’ `POSTED` â†’ `REVERSED`ï¼ˆä¸å¯é€†ï¼‰
- **å¼‚å¸¸**ï¼š`BusinessException("æŠ¥é”€å•å·²è¿‡è´¦ï¼Œæ— æ³•é‡å¤è¿‡è´¦")`

**è§„åˆ™2ï¼šé‡‘é¢ä¸€è‡´æ€§æ ¡éªŒ**
- **è§„åˆ™**ï¼šæŠ¥é”€å•æ€»é‡‘é¢å¿…é¡»ç­‰äºæ˜ç»†é‡‘é¢æ€»å’Œ
- **å®ç°ä½ç½®**ï¼š`BizExpenseClaimServiceImpl.postExpenseClaim()` ç¬¬299-309è¡Œ
- **å¼‚å¸¸**ï¼š`BusinessException("æŠ¥é”€å•æ€»é‡‘é¢ä¸æ˜ç»†é‡‘é¢æ€»å’Œä¸ä¸€è‡´")`

**è§„åˆ™3ï¼šå‡­è¯ç”Ÿæˆè§„åˆ™**
- **å€Ÿæ–¹åˆ†å½•**ï¼šæ¯æ¡è´¹ç”¨æ˜ç»†ç”Ÿæˆä¸€æ¡å€Ÿæ–¹åˆ†å½•
  - ç§‘ç›®ï¼šæ˜ç»†ä¸­çš„è´¹ç”¨ç§‘ç›®ï¼ˆ`detail.getDebitAccountId()`ï¼‰
  - æ–¹å‘ï¼šDEBIT
  - é‡‘é¢ï¼šæ˜ç»†é‡‘é¢
  - æ‘˜è¦ï¼šæ˜ç»†æè¿°
- **è´·æ–¹åˆ†å½•**ï¼šæ±‡æ€»æ‰€æœ‰æ˜ç»†é‡‘é¢ï¼Œç”Ÿæˆä¸€æ¡è´·æ–¹åˆ†å½•
  - ç§‘ç›®ï¼šæŠ¥é”€å•çš„ä»˜æ¬¾è´¦æˆ·ï¼ˆ`claim.getCreditAccountId()`ï¼‰
  - æ–¹å‘ï¼šCREDIT
  - é‡‘é¢ï¼šæŠ¥é”€å•æ€»é‡‘é¢
  - æ‘˜è¦ï¼šæŠ¥é”€å•å·

**è§„åˆ™4ï¼šå‡­è¯çŠ¶æ€è®¾ç½®**
- **è§„åˆ™**ï¼šè¿‡è´¦å³å®¡æ ¸ï¼Œç”Ÿæˆçš„å‡­è¯çŠ¶æ€ç›´æ¥è®¾ç½®ä¸ºå·²å®¡æ ¸ï¼ˆstatus=1ï¼‰
- **å®ç°ä½ç½®**ï¼š`BizExpenseClaimServiceImpl.postExpenseClaim()` ç¬¬315è¡Œ
- **è¯´æ˜**ï¼šä¸šåŠ¡å•æ®è¿‡è´¦ç”Ÿæˆçš„å‡­è¯æ— éœ€å†æ¬¡å®¡æ ¸ï¼Œç›´æ¥ç”Ÿæ•ˆ

### 4.2.3 èµ„äº§è´Ÿå€ºè¡¨ç”Ÿæˆæµç¨‹

èµ„äº§è´Ÿå€ºè¡¨ç”Ÿæˆæ˜¯æŠ¥è¡¨æœåŠ¡çš„æ ¸å¿ƒæµç¨‹ï¼Œæ¶‰åŠç§‘ç›®ä½™é¢çš„æ±‡æ€»è®¡ç®—å’ŒæŠ¥è¡¨ç»“æ„çš„æ„å»ºã€‚

#### 4.2.3.1 æµç¨‹æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant Controller as æ§åˆ¶å™¨å±‚
    participant ReportService as ReportServiceImpl
    participant AccountingService as AccountingServiceImpl
    participant AccountMapper as FinAccountMapper
    participant SplitMapper as FinSplitMapper
    
    Controller->>ReportService: generateBalanceSheet(reportDate)
    
    Note over ReportService: 1. è·å–æ‰€æœ‰ç§‘ç›®ä½™é¢
    ReportService->>AccountingService: calculateAllAccountBalances(reportDate)
    AccountingService->>AccountMapper: selectList(null)
    AccountMapper-->>AccountingService: List~FinAccount~
    AccountingService->>SplitMapper: selectBalanceByAccountIds(accountIds, date)
    SplitMapper-->>AccountingService: List~AccountBalanceSummary~
    AccountingService->>AccountingService: è®¡ç®—æ¯ä¸ªç§‘ç›®çš„ä½™é¢
    AccountingService-->>ReportService: List~AccountBalanceDTO~
    
    Note over ReportService: 2. åˆ†ç±»æ±‡æ€»
    loop éå†æ¯ä¸ªç§‘ç›®ä½™é¢
        alt èµ„äº§ç±» (ASSET)
            ReportService->>ReportService: æ·»åŠ åˆ°èµ„äº§åˆ—è¡¨
            ReportService->>ReportService: ç´¯åŠ èµ„äº§æ€»é¢
        else è´Ÿå€ºç±» (LIABILITY)
            ReportService->>ReportService: æ·»åŠ åˆ°è´Ÿå€ºåˆ—è¡¨
            ReportService->>ReportService: ç´¯åŠ è´Ÿå€ºæ€»é¢
        else æƒç›Šç±» (EQUITY)
            ReportService->>ReportService: æ·»åŠ åˆ°æƒç›Šåˆ—è¡¨
            ReportService->>ReportService: ç´¯åŠ æƒç›Šæ€»é¢
        else æ”¶å…¥ç±» (INCOME)
            ReportService->>ReportService: ç´¯åŠ æ”¶å…¥æ€»é¢
        else è´¹ç”¨ç±» (EXPENSE)
            ReportService->>ReportService: ç´¯åŠ è´¹ç”¨æ€»é¢
        end
    end
    
    Note over ReportService: 3. è®¡ç®—å‡€åˆ©æ¶¦
    ReportService->>ReportService: å‡€åˆ©æ¶¦ = æ”¶å…¥æ€»é¢ - è´¹ç”¨æ€»é¢
    
    Note over ReportService: 4. å¤„ç†æœ¬å¹´åˆ©æ¶¦ç§‘ç›®
    alt æœ¬å¹´åˆ©æ¶¦ç§‘ç›®å­˜åœ¨
        ReportService->>ReportService: æ›´æ–°æœ¬å¹´åˆ©æ¶¦é‡‘é¢ = å‡€åˆ©æ¶¦
        ReportService->>ReportService: è°ƒæ•´æƒç›Šæ€»é¢
    else å‡€åˆ©æ¶¦ != 0
        ReportService->>ReportService: åˆ›å»ºæœ¬å¹´åˆ©æ¶¦é¡¹ç›®
        ReportService->>ReportService: æ·»åŠ åˆ°æƒç›Šåˆ—è¡¨
    end
    
    Note over ReportService: 5. è®¡ç®—åˆè®¡
    ReportService->>ReportService: èµ„äº§æ€»è®¡ = èµ„äº§æ€»é¢
    ReportService->>ReportService: è´Ÿå€ºåŠæƒç›Šæ€»è®¡ = è´Ÿå€ºæ€»é¢ + æƒç›Šæ€»é¢
    ReportService->>ReportService: æ ¡éªŒï¼šèµ„äº§æ€»è®¡ == è´Ÿå€ºåŠæƒç›Šæ€»è®¡
    
    ReportService-->>Controller: BalanceSheetDTO
```

#### 4.2.3.2 ä¸šåŠ¡è§„åˆ™è¯¦è§£

**è§„åˆ™1ï¼šç§‘ç›®ç±»å‹åˆ†ç±»**
- **èµ„äº§ç±»ï¼ˆASSETï¼‰**ï¼šä½™é¢ = å€Ÿæ–¹ - è´·æ–¹ï¼Œä½™é¢ä¸ºæ­£æ•°æ—¶åœ¨å€Ÿæ–¹
- **è´Ÿå€ºç±»ï¼ˆLIABILITYï¼‰**ï¼šä½™é¢ = è´·æ–¹ - å€Ÿæ–¹ï¼Œä½™é¢ä¸ºæ­£æ•°æ—¶åœ¨è´·æ–¹
- **æƒç›Šç±»ï¼ˆEQUITYï¼‰**ï¼šä½™é¢ = è´·æ–¹ - å€Ÿæ–¹ï¼Œä½™é¢ä¸ºæ­£æ•°æ—¶åœ¨è´·æ–¹
- **æ”¶å…¥ç±»ï¼ˆINCOMEï¼‰**ï¼šä½™é¢ = è´·æ–¹ - å€Ÿæ–¹ï¼Œç”¨äºè®¡ç®—å‡€åˆ©æ¶¦
- **è´¹ç”¨ç±»ï¼ˆEXPENSEï¼‰**ï¼šä½™é¢ = å€Ÿæ–¹ - è´·æ–¹ï¼Œç”¨äºè®¡ç®—å‡€åˆ©æ¶¦

**è§„åˆ™2ï¼šå‡€åˆ©æ¶¦è®¡ç®—**
- **å…¬å¼**ï¼šå‡€åˆ©æ¶¦ = æ”¶å…¥ç±»ç§‘ç›®ä½™é¢æ€»å’Œ - è´¹ç”¨ç±»ç§‘ç›®ä½™é¢æ€»å’Œ
- **å®ç°ä½ç½®**ï¼š`ReportServiceImpl.generateBalanceSheet()` ç¬¬142-145è¡Œ
- **è¯´æ˜**ï¼šæ”¶å…¥ç±»å’Œè´¹ç”¨ç±»ç§‘ç›®ä¸ç›´æ¥å‡ºç°åœ¨èµ„äº§è´Ÿå€ºè¡¨ï¼Œè€Œæ˜¯é€šè¿‡å‡€åˆ©æ¶¦å½±å“æ‰€æœ‰è€…æƒç›Š

**è§„åˆ™3ï¼šæœ¬å¹´åˆ©æ¶¦å¤„ç†**
- **è§„åˆ™**ï¼šå¦‚æœå­˜åœ¨"æœ¬å¹´åˆ©æ¶¦"ç§‘ç›®ï¼ˆä»£ç 4103ï¼‰ï¼Œä½¿ç”¨è®¡ç®—å‡ºçš„å‡€åˆ©æ¶¦æ›´æ–°å…¶é‡‘é¢
- **å®ç°ä½ç½®**ï¼š`ReportServiceImpl.generateBalanceSheet()` ç¬¬147-165è¡Œ
- **é€»è¾‘**ï¼š
  1. æŸ¥æ‰¾"æœ¬å¹´åˆ©æ¶¦"ç§‘ç›®
  2. å¦‚æœå­˜åœ¨ï¼Œæ›´æ–°å…¶é‡‘é¢ä¸ºå‡€åˆ©æ¶¦
  3. å¦‚æœä¸å­˜åœ¨ä½†å‡€åˆ©æ¶¦ä¸ä¸ºé›¶ï¼Œåˆ›å»ºæ–°çš„æœ¬å¹´åˆ©æ¶¦é¡¹ç›®

**è§„åˆ™4ï¼šå¹³è¡¡æ ¡éªŒ**
- **è§„åˆ™**ï¼šèµ„äº§æ€»è®¡å¿…é¡»ç­‰äºè´Ÿå€ºåŠæƒç›Šæ€»è®¡ï¼ˆä¼šè®¡æ’ç­‰å¼ï¼‰
- **å®ç°ä½ç½®**ï¼š`ReportServiceImpl.generateBalanceSheet()` ç¬¬173è¡Œ
- **å…¬å¼**ï¼š`èµ„äº§æ€»è®¡ = è´Ÿå€ºæ€»è®¡ + æ‰€æœ‰è€…æƒç›Šæ€»è®¡`
- **è¯´æ˜**ï¼šå¦‚æœä¸å¹³è¡¡ï¼Œè¯´æ˜æ•°æ®å­˜åœ¨å¼‚å¸¸ï¼Œéœ€è¦æ’æŸ¥

## 4.3 å…³é”®æŠ€æœ¯å®ç°

### 4.3.1 äº‹åŠ¡ç®¡ç†

#### 4.3.1.1 äº‹åŠ¡ä¼ æ’­æœºåˆ¶

ç³»ç»Ÿé‡‡ç”¨ **Spring å£°æ˜å¼äº‹åŠ¡ç®¡ç†**ï¼Œä½¿ç”¨ `@Transactional` æ³¨è§£æ§åˆ¶äº‹åŠ¡è¾¹ç•Œã€‚æ‰€æœ‰å†™æ“ä½œå‡é‡‡ç”¨é»˜è®¤çš„ `REQUIRED` ä¼ æ’­æœºåˆ¶ï¼Œç¡®ä¿åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å®Œæˆã€‚

**äº‹åŠ¡é…ç½®ç»Ÿè®¡**ï¼š
- **å†™æ“ä½œäº‹åŠ¡**ï¼š`@Transactional(rollbackFor = Exception.class)` - ä»»ä½•å¼‚å¸¸éƒ½å›æ»š
- **è¯»æ“ä½œäº‹åŠ¡**ï¼š`@Transactional(readOnly = true)` - åªè¯»äº‹åŠ¡ï¼Œä¼˜åŒ–æ€§èƒ½

**å…¸å‹äº‹åŠ¡æ–¹æ³•ç¤ºä¾‹**ï¼š

```java
// å‡­è¯ä¿å­˜ï¼šå¤šè¡¨æ“ä½œï¼Œå¿…é¡»ä¿è¯åŸå­æ€§
@Override
@Transactional(rollbackFor = Exception.class)
public void saveVoucher(FinTransaction transaction) {
    // 1. ä¿å­˜ä¸»è¡¨
    this.save(transaction);
    // 2. ä¿å­˜å­è¡¨ï¼ˆåˆ†å½•ï¼‰
    for (FinSplit split : transaction.getSplits()) {
        split.setTransId(transaction.getTransId());
        splitMapper.insert(split);
    }
}
```

#### 4.3.1.2 å›æ»šç­–ç•¥

**å›æ»šç­–ç•¥**ï¼š`rollbackFor = Exception.class`

- **è®¾è®¡ç†å¿µ**ï¼šä»»ä½•å¼‚å¸¸ï¼ˆåŒ…æ‹¬å—æ£€å¼‚å¸¸å’Œè¿è¡Œæ—¶å¼‚å¸¸ï¼‰éƒ½ä¼šè§¦å‘äº‹åŠ¡å›æ»š
- **ä¼˜åŠ¿**ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼Œé¿å…éƒ¨åˆ†æ•°æ®å†™å…¥å¯¼è‡´çš„è„æ•°æ®
- **åº”ç”¨åœºæ™¯**ï¼š
  - å‡­è¯ä¿å­˜ï¼šä¸»è¡¨å’Œå­è¡¨å¿…é¡»åŒæ—¶æˆåŠŸæˆ–åŒæ—¶å¤±è´¥
  - æŠ¥é”€å•è¿‡è´¦ï¼šå‡­è¯ç”Ÿæˆå’ŒæŠ¥é”€å•çŠ¶æ€æ›´æ–°å¿…é¡»åŸå­æ€§
  - ç§‘ç›®åˆ é™¤ï¼šå¿…é¡»ç¡®ä¿ç§‘ç›®æœªè¢«ä½¿ç”¨æ‰èƒ½åˆ é™¤

**äº‹åŠ¡è¾¹ç•Œè®¾è®¡åŸåˆ™**ï¼š
1. **æœ€å°äº‹åŠ¡åŸåˆ™**ï¼šäº‹åŠ¡èŒƒå›´å°½å¯èƒ½å°ï¼Œå‡å°‘é”æŒæœ‰æ—¶é—´
2. **ä¸šåŠ¡å®Œæ•´æ€§**ï¼šä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡æ“ä½œå¿…é¡»åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­
3. **å¼‚å¸¸å¤„ç†**ï¼šä¸šåŠ¡å¼‚å¸¸ï¼ˆBusinessExceptionï¼‰ä¼šè§¦å‘å›æ»šï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§

#### 4.3.1.3 äº‹åŠ¡åµŒå¥—å¤„ç†

ç³»ç»Ÿå­˜åœ¨äº‹åŠ¡åµŒå¥—åœºæ™¯ï¼š

**åœºæ™¯1ï¼šæŠ¥é”€å•è¿‡è´¦è°ƒç”¨å‡­è¯ä¿å­˜**
```java
// å¤–å±‚äº‹åŠ¡ï¼šæŠ¥é”€å•è¿‡è´¦
@Transactional(rollbackFor = Exception.class)
public FinTransaction postExpenseClaim(Long claimId) {
    // ...
    // å†…å±‚äº‹åŠ¡ï¼šå‡­è¯ä¿å­˜ï¼ˆä¼šåŠ å…¥å¤–å±‚äº‹åŠ¡ï¼‰
    transactionService.saveVoucher(voucher);
    // ...
}
```

**å¤„ç†æœºåˆ¶**ï¼šç”±äºä½¿ç”¨ `REQUIRED` ä¼ æ’­æœºåˆ¶ï¼Œå†…å±‚æ–¹æ³•ä¼šåŠ å…¥å¤–å±‚äº‹åŠ¡ï¼Œå½¢æˆåŒä¸€ä¸ªäº‹åŠ¡ã€‚å¦‚æœå†…å±‚æŠ›å‡ºå¼‚å¸¸ï¼Œæ•´ä¸ªäº‹åŠ¡éƒ½ä¼šå›æ»šã€‚

### 4.3.2 å¹¶å‘æ§åˆ¶

#### 4.3.2.1 å½“å‰å®ç°åˆ†æ

**ç°çŠ¶**ï¼šç³»ç»Ÿ**æœªä½¿ç”¨æ˜¾å¼çš„å¹¶å‘æ§åˆ¶æœºåˆ¶**ï¼ˆå¦‚ `synchronized`ã€`ReentrantLock`ã€`Redis Lock` ç­‰ï¼‰ã€‚

**æ½œåœ¨å¹¶å‘é—®é¢˜**ï¼š

1. **å‡­è¯å·ç”Ÿæˆå¹¶å‘é—®é¢˜**
   - **é—®é¢˜ä½ç½®**ï¼š`TransactionServiceImpl.generateVoucherNo()` ç¬¬235-259è¡Œ
   - **é—®é¢˜æè¿°**ï¼šå¤šçº¿ç¨‹åŒæ—¶ç”Ÿæˆå‡­è¯å·æ—¶ï¼Œå¯èƒ½ç”Ÿæˆé‡å¤çš„å‡­è¯å·
   - **åŸå› **ï¼šæŸ¥è¯¢æœ€å¤§åºå·å’Œæ’å…¥æ–°è®°å½•ä¹‹é—´å­˜åœ¨æ—¶é—´çª—å£
   - **å½±å“**ï¼šå¯èƒ½å¯¼è‡´å‡­è¯å·é‡å¤ï¼Œè¿åå”¯ä¸€æ€§çº¦æŸ

2. **æŠ¥é”€å•å·ç”Ÿæˆå¹¶å‘é—®é¢˜**
   - **é—®é¢˜ä½ç½®**ï¼š`BizExpenseClaimServiceImpl.generateClaimNo()` ç¬¬415-438è¡Œ
   - **é—®é¢˜æè¿°**ï¼šä¸å‡­è¯å·ç”Ÿæˆç±»ä¼¼ï¼Œå­˜åœ¨å¹¶å‘é‡å¤é£é™©

#### 4.3.2.2 å¹¶å‘æ§åˆ¶å»ºè®®

**æ–¹æ¡ˆ1ï¼šæ•°æ®åº“å”¯ä¸€çº¦æŸ + é‡è¯•æœºåˆ¶**
```java
@Transactional(rollbackFor = Exception.class)
public String generateVoucherNo() {
    int maxRetries = 3;
    for (int i = 0; i < maxRetries; i++) {
        try {
            // ç”Ÿæˆå‡­è¯å·å¹¶å°è¯•æ’å…¥
            String voucherNo = generateVoucherNoInternal();
            // å¦‚æœæ•°æ®åº“æœ‰å”¯ä¸€çº¦æŸï¼Œé‡å¤æ—¶ä¼šæŠ›å‡ºå¼‚å¸¸
            return voucherNo;
        } catch (DuplicateKeyException e) {
            if (i == maxRetries - 1) {
                throw new BusinessException("ç”Ÿæˆå‡­è¯å·å¤±è´¥ï¼Œè¯·é‡è¯•");
            }
            // é‡è¯•
            Thread.sleep(10); // çŸ­æš‚å»¶è¿Ÿ
        }
    }
}
```

**æ–¹æ¡ˆ2ï¼šåˆ†å¸ƒå¼é”ï¼ˆRedis Lockï¼‰**
```java
@Autowired
private RedisTemplate<String, String> redisTemplate;

public String generateVoucherNo() {
    String lockKey = "lock:voucher_no:" + LocalDate.now();
    RLock lock = redissonClient.getLock(lockKey);
    try {
        if (lock.tryLock(5, 10, TimeUnit.SECONDS)) {
            // ç”Ÿæˆå‡­è¯å·
            return generateVoucherNoInternal();
        } else {
            throw new BusinessException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
        }
    } finally {
        if (lock.isHeldByCurrentThread()) {
            lock.unlock();
        }
    }
}
```

**æ–¹æ¡ˆ3ï¼šæ•°æ®åº“åºåˆ—ï¼ˆæ¨èï¼‰**
```sql
-- åˆ›å»ºåºåˆ—è¡¨
CREATE TABLE fin_sequence (
    seq_name VARCHAR(50) PRIMARY KEY,
    seq_value BIGINT NOT NULL DEFAULT 0,
    updated_at DATETIME NOT NULL
);

-- ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹æˆ–æ•°æ®åº“å‡½æ•°ç”Ÿæˆåºå·
```

### 4.3.3 è®¾è®¡æ¨¡å¼

#### 4.3.3.1 æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼ˆTemplate Method Patternï¼‰

**åº”ç”¨åœºæ™¯**ï¼šMyBatis-Plus çš„ `ServiceImpl` åŸºç±»

**å®ç°æ–¹å¼**ï¼š
```java
public class TransactionServiceImpl extends ServiceImpl<FinTransactionMapper, FinTransaction> 
    implements IFinTransactionService {
    // ç»§æ‰¿åŸºç±»çš„é€šç”¨ CRUD æ–¹æ³•
    // this.save()ã€this.getById()ã€this.updateById() ç­‰
}
```

**è§£å†³çš„é—®é¢˜**ï¼š
- å‡å°‘é‡å¤ä»£ç ï¼šé€šç”¨çš„å¢åˆ æ”¹æŸ¥æ“ä½œç”±åŸºç±»æä¾›
- ç»Ÿä¸€æ•°æ®è®¿é—®ï¼šæ‰€æœ‰ Service ä½¿ç”¨ç›¸åŒçš„æ•°æ®è®¿é—®æ¨¡å¼
- æ˜“äºæ‰©å±•ï¼šå­ç±»å¯ä»¥é‡å†™åŸºç±»æ–¹æ³•å®ç°å®šåˆ¶é€»è¾‘

#### 4.3.3.2 ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰

**åº”ç”¨åœºæ™¯**ï¼šç§‘ç›®ä½™é¢è®¡ç®—ç­–ç•¥

**å®ç°æ–¹å¼**ï¼š
```java
// AccountingServiceImpl.calculateBalanceByType()
private BigDecimal calculateBalanceByType(String accountType, BigDecimal debit, BigDecimal credit) {
    if ("ASSET".equals(accountType) || "EXPENSE".equals(accountType)) {
        // èµ„äº§/è´¹ç”¨ç±»ç­–ç•¥ï¼šä½™é¢ = å€Ÿæ–¹ - è´·æ–¹
        return debit.subtract(credit);
    } else {
        // è´Ÿå€º/æƒç›Š/æ”¶å…¥ç±»ç­–ç•¥ï¼šä½™é¢ = è´·æ–¹ - å€Ÿæ–¹
        return credit.subtract(debit);
    }
}
```

**è§£å†³çš„é—®é¢˜**ï¼š
- æ¶ˆé™¤ if-else é“¾ï¼šä¸åŒç§‘ç›®ç±»å‹ä½¿ç”¨ä¸åŒçš„è®¡ç®—ç­–ç•¥
- æ˜“äºæ‰©å±•ï¼šæ–°å¢ç§‘ç›®ç±»å‹åªéœ€æ·»åŠ æ–°çš„ç­–ç•¥åˆ†æ”¯
- ä»£ç æ¸…æ™°ï¼šç­–ç•¥é€»è¾‘é›†ä¸­ç®¡ç†ï¼Œæ˜“äºç»´æŠ¤

**ä¼˜åŒ–å»ºè®®**ï¼šå¯ä»¥è¿›ä¸€æ­¥æŠ½è±¡ä¸ºç­–ç•¥æ¥å£ï¼š
```java
interface BalanceCalculationStrategy {
    BigDecimal calculate(BigDecimal debit, BigDecimal credit);
}

class AssetBalanceStrategy implements BalanceCalculationStrategy {
    public BigDecimal calculate(BigDecimal debit, BigDecimal credit) {
        return debit.subtract(credit);
    }
}
```

#### 4.3.3.3 è´£ä»»é“¾æ¨¡å¼ï¼ˆChain of Responsibility Patternï¼‰

**åº”ç”¨åœºæ™¯**ï¼šå‡­è¯æ ¡éªŒæµç¨‹

**å®ç°æ–¹å¼**ï¼š
```java
// TransactionServiceImpl.saveVoucher()
public void saveVoucher(FinTransaction transaction) {
    // 1. æ ¡éªŒåˆ†å½•æ•°é‡
    validateSplitCount(transaction.getSplits());
    // 2. æ ¡éªŒæœ«çº§ç§‘ç›®
    validateLeafAccounts(transaction.getSplits());
    // 3. æ ¡éªŒå€Ÿè´·å¹³è¡¡
    validateDebitCreditBalance(transaction.getSplits());
    // 4. æ ¡éªŒç§‘ç›®æ–¹å‘ç»„åˆ
    validateAccountDirectionCombination(transaction.getSplits());
    // 5. æ ¡éªŒä½™é¢æ–¹å‘
    validateBalanceDirection(transaction.getSplits(), transaction.getTransDate());
    // 6. æ ¡éªŒä¸šåŠ¡å®ä½“å…³è”
    ownerValidationService.validateOwnerAssociation(transaction.getSplits());
    // 7. ä¿å­˜æ•°æ®
    saveData(transaction);
}
```

**è§£å†³çš„é—®é¢˜**ï¼š
- æ ¡éªŒé€»è¾‘è§£è€¦ï¼šæ¯ä¸ªæ ¡éªŒæ­¥éª¤ç‹¬ç«‹ï¼Œæ˜“äºç»´æŠ¤å’Œæµ‹è¯•
- çµæ´»æ‰©å±•ï¼šå¯ä»¥è½»æ¾æ·»åŠ æ–°çš„æ ¡éªŒæ­¥éª¤
- èŒè´£æ¸…æ™°ï¼šæ¯ä¸ªæ ¡éªŒæ–¹æ³•åªè´Ÿè´£ä¸€ä¸ªä¸šåŠ¡è§„åˆ™

#### 4.3.3.4 é€‚é…å™¨æ¨¡å¼ï¼ˆAdapter Patternï¼‰

**åº”ç”¨åœºæ™¯**ï¼šEntity åˆ° DTO çš„è½¬æ¢

**å®ç°æ–¹å¼**ï¼š
```java
// FinAccountServiceImpl.getAccountTree()
List<AccountDTO> accountDTOs = allAccounts.stream()
    .map(account -> {
        AccountDTO dto = new AccountDTO();
        BeanUtils.copyProperties(account, dto); // é€‚é…å™¨è½¬æ¢
        return dto;
    })
    .collect(Collectors.toList());
```

**è§£å†³çš„é—®é¢˜**ï¼š
- æ•°æ®æ ¼å¼è½¬æ¢ï¼šEntity é€‚é…ä¸ºå‰ç«¯éœ€è¦çš„ DTO æ ¼å¼
- è§£è€¦æ•°æ®å±‚å’Œè¡¨ç°å±‚ï¼šEntity ç»“æ„å˜åŒ–ä¸å½±å“ DTO
- ç»Ÿä¸€è½¬æ¢é€»è¾‘ï¼šä½¿ç”¨ `BeanUtils` ç»Ÿä¸€å¤„ç†å±æ€§å¤åˆ¶

## 4.4 æ•°æ®æµä¸å¼‚å¸¸è§„èŒƒ

### 4.4.1 DTO åˆ° Entity çš„è½¬åŒ–ç­–ç•¥

#### 4.4.1.1 è½¬åŒ–æ¨¡å¼

ç³»ç»Ÿé‡‡ç”¨**åŒå‘è½¬æ¢**ç­–ç•¥ï¼š
- **Controller â†’ Service**ï¼šDTO â†’ Entityï¼ˆæ¥æ”¶å‰ç«¯æ•°æ®ï¼‰
- **Service â†’ Controller**ï¼šEntity â†’ DTOï¼ˆè¿”å›å‰ç«¯æ•°æ®ï¼‰

#### 4.4.1.2 è½¬åŒ–å®ç°æ–¹å¼

**æ–¹å¼1ï¼šBeanUtils å±æ€§å¤åˆ¶ï¼ˆä¸»è¦æ–¹å¼ï¼‰**

```java
// FinAccountServiceImpl.getAccountTree()
AccountDTO dto = new AccountDTO();
BeanUtils.copyProperties(account, dto); // Entity â†’ DTO
```

**ä¼˜åŠ¿**ï¼š
- ä»£ç ç®€æ´ï¼šä¸€è¡Œä»£ç å®Œæˆè½¬æ¢
- æ€§èƒ½è¾ƒå¥½ï¼šä½¿ç”¨åå°„ï¼Œä½†ç»è¿‡ä¼˜åŒ–
- è‡ªåŠ¨åŒ¹é…ï¼šåŒåå±æ€§è‡ªåŠ¨å¤åˆ¶

**é™åˆ¶**ï¼š
- åªèƒ½å¤åˆ¶åŒåå±æ€§
- å¤æ‚å¯¹è±¡éœ€è¦æ‰‹åŠ¨å¤„ç†
- åµŒå¥—å¯¹è±¡éœ€è¦é€’å½’è½¬æ¢

**æ–¹å¼2ï¼šæ‰‹åŠ¨å±æ€§æ˜ å°„ï¼ˆå¤æ‚åœºæ™¯ï¼‰**

```java
// TransactionServiceImpl.getVoucherById()
for (FinSplit split : splits) {
    if (split.getAccountId() != null) {
        FinAccount account = accountMapper.selectById(split.getAccountId());
        if (account != null) {
            split.setAccountName(account.getAccountName()); // æ‰‹åŠ¨å¡«å……
            split.setAccountCode(account.getAccountCode());
        }
    }
}
```

**åº”ç”¨åœºæ™¯**ï¼š
- éœ€è¦å…³è”æŸ¥è¯¢å…¶ä»–è¡¨æ•°æ®
- éœ€è¦è®¡ç®—æ´¾ç”Ÿå±æ€§
- éœ€è¦å¤„ç†åµŒå¥—å¯¹è±¡

**æ–¹å¼3ï¼šStream API æ‰¹é‡è½¬æ¢**

```java
// FinAccountServiceImpl.getAccountTree()
List<AccountDTO> accountDTOs = allAccounts.stream()
    .filter(account -> account != null)
    .map(account -> {
        AccountDTO dto = new AccountDTO();
        BeanUtils.copyProperties(account, dto);
        // è®¾ç½®é¢å¤–å±æ€§
        if (dto.getChildren() == null) {
            dto.setChildren(new ArrayList<>());
        }
        return dto;
    })
    .filter(dto -> dto != null)
    .collect(Collectors.toList());
```

**ä¼˜åŠ¿**ï¼š
- å‡½æ•°å¼ç¼–ç¨‹é£æ ¼
- æ”¯æŒé“¾å¼æ“ä½œå’Œè¿‡æ»¤
- ä»£ç å¯è¯»æ€§å¥½

#### 4.4.1.3 è½¬åŒ–æœ€ä½³å®è·µ

**å®è·µ1ï¼šç©ºå€¼å®‰å…¨å¤„ç†**
```java
// æ£€æŸ¥ Entity æ˜¯å¦ä¸º null
if (account == null) {
    return null; // æˆ–è¿”å›é»˜è®¤å€¼
}

// æ£€æŸ¥é›†åˆæ˜¯å¦ä¸º null
if (allAccounts == null || allAccounts.isEmpty()) {
    return new ArrayList<>(); // è¿”å›ç©ºé›†åˆè€Œé null
}
```

**å®è·µ2ï¼šåµŒå¥—å¯¹è±¡å¤„ç†**
```java
// æ ‘å½¢ç»“æ„è½¬æ¢
private List<AccountDTO> buildTree(List<AccountDTO> allAccounts, Long parentId) {
    // é€’å½’æ„å»ºæ ‘å½¢ç»“æ„
    // å¤„ç† parent-child å…³ç³»
}
```

**å®è·µ3ï¼šæ´¾ç”Ÿå±æ€§è®¡ç®—**
```java
// è®¡ç®—ä½™é¢ï¼ˆæ´¾ç”Ÿå±æ€§ï¼‰
BigDecimal balance = calculateBalanceByType(
    account.getAccountType(), 
    debitAmount, 
    creditAmount
);
dto.setBalance(balance);
```

### 4.4.2 æ ¸å¿ƒä¸šåŠ¡å¼‚å¸¸ç±»åŠå…¶è§¦å‘åœºæ™¯

#### 4.4.2.1 å¼‚å¸¸ç±»å®šä¹‰

```java
@Getter
public class BusinessException extends RuntimeException {
    private final Integer code;
    
    public BusinessException(String message) {
        super(message);
        this.code = 500;
    }
    
    public BusinessException(Integer code, String message) {
        super(message);
        this.code = code;
    }
}
```

**è®¾è®¡ç‰¹ç‚¹**ï¼š
- ç»§æ‰¿ `RuntimeException`ï¼šä¸å—æ£€å¼‚å¸¸ï¼Œç®€åŒ–ä»£ç 
- åŒ…å«é”™è¯¯ç ï¼šä¾¿äºå‰ç«¯ç»Ÿä¸€å¤„ç†
- åŒ…å«é”™è¯¯æ¶ˆæ¯ï¼šæä¾›è¯¦ç»†çš„é”™è¯¯æè¿°

#### 4.4.2.2 å¼‚å¸¸è§¦å‘åœºæ™¯åˆ†ç±»

**1. æ•°æ®æ ¡éªŒå¼‚å¸¸**

| å¼‚å¸¸æ¶ˆæ¯ | è§¦å‘ä½ç½® | è§¦å‘æ¡ä»¶ |
|---------|---------|---------|
| "å‡­è¯è‡³å°‘éœ€è¦ä¸€å€Ÿä¸€è´·ä¸¤æ¡åˆ†å½•" | `TransactionServiceImpl.saveVoucher()` | åˆ†å½•æ•°é‡ < 2 |
| "å‡­è¯åˆ†å½•åªèƒ½ä½¿ç”¨æœ«çº§ç§‘ç›®" | `TransactionServiceImpl.validateLeafAccounts()` | ä½¿ç”¨äº†éæœ«çº§ç§‘ç›® |
| "å€Ÿè´·ä¸å¹³ï¼å€Ÿæ–¹ï¼šXï¼Œè´·æ–¹ï¼šY" | `TransactionServiceImpl.validateDebitCreditBalance()` | å€Ÿæ–¹æ€»é¢ â‰  è´·æ–¹æ€»é¢ |
| "åˆ†å½•é‡‘é¢å¿…é¡»å¤§äº0" | `TransactionServiceImpl.validateDebitCreditBalance()` | åˆ†å½•é‡‘é¢ <= 0 |
| "ç§‘ç›®\"XXX\"ä½™é¢å°†å˜ä¸ºè´Ÿæ•°" | `TransactionServiceImpl.validateBalanceDirection()` | èµ„äº§ç±»ç§‘ç›®ä½™é¢å°†å˜ä¸ºè´Ÿæ•° |
| "æŠ¥é”€å•æ€»é‡‘é¢ä¸æ˜ç»†é‡‘é¢æ€»å’Œä¸ä¸€è‡´" | `BizExpenseClaimServiceImpl.postExpenseClaim()` | æ€»é‡‘é¢ â‰  æ˜ç»†é‡‘é¢æ€»å’Œ |

**2. çŠ¶æ€æµè½¬å¼‚å¸¸**

| å¼‚å¸¸æ¶ˆæ¯ | è§¦å‘ä½ç½® | è§¦å‘æ¡ä»¶ |
|---------|---------|---------|
| "å·²å®¡æ ¸çš„å‡­è¯ä¸èƒ½ä¿®æ”¹" | `TransactionServiceImpl.updateVoucher()` | å‡­è¯çŠ¶æ€ = 1ï¼ˆå·²å®¡æ ¸ï¼‰ |
| "å·²å®¡æ ¸çš„å‡­è¯ä¸èƒ½åˆ é™¤" | `TransactionServiceImpl.deleteVoucher()` | å‡­è¯çŠ¶æ€ = 1ï¼ˆå·²å®¡æ ¸ï¼‰ |
| "å‡­è¯å·²å®¡æ ¸" | `TransactionServiceImpl.auditVoucher()` | å‡­è¯çŠ¶æ€ = 1ï¼ˆå·²å®¡æ ¸ï¼‰ |
| "æŠ¥é”€å•å·²è¿‡è´¦ï¼Œæ— æ³•é‡å¤è¿‡è´¦" | `BizExpenseClaimServiceImpl.postExpenseClaim()` | æŠ¥é”€å•çŠ¶æ€ = POSTED |
| "å·²è¿‡è´¦çš„æŠ¥é”€å•ä¸èƒ½ä¿®æ”¹" | `BizExpenseClaimServiceImpl.updateExpenseClaim()` | æŠ¥é”€å•çŠ¶æ€ = POSTED |

**3. æ•°æ®ä¸å­˜åœ¨å¼‚å¸¸**

| å¼‚å¸¸æ¶ˆæ¯ | è§¦å‘ä½ç½® | è§¦å‘æ¡ä»¶ |
|---------|---------|---------|
| "å‡­è¯ä¸å­˜åœ¨" | `TransactionServiceImpl.updateVoucher()` | å‡­è¯IDä¸å­˜åœ¨ |
| "æŠ¥é”€å•ä¸å­˜åœ¨ï¼ŒID: X" | `BizExpenseClaimServiceImpl.postExpenseClaim()` | æŠ¥é”€å•IDä¸å­˜åœ¨ |
| "ä»˜æ¬¾è´¦æˆ·ä¸å­˜åœ¨ï¼ŒID: X" | `BizExpenseClaimServiceImpl.validateExpenseClaim()` | è´¦æˆ·IDä¸å­˜åœ¨ |
| "æœªæ‰¾åˆ°ä¸šåŠ¡å®ä½“ï¼ˆIDï¼šXï¼Œç±»å‹ï¼šYï¼‰" | `OwnerValidationServiceImpl.validateSplitOwnerAssociation()` | ä¸šåŠ¡å®ä½“ä¸å­˜åœ¨ |

**4. ä¸šåŠ¡è§„åˆ™å¼‚å¸¸**

| å¼‚å¸¸æ¶ˆæ¯ | è§¦å‘ä½ç½® | è§¦å‘æ¡ä»¶ |
|---------|---------|---------|
| "è¯¥ç§‘ç›®ä¸‹å­˜åœ¨å­ç§‘ç›®ï¼Œæ— æ³•åˆ é™¤" | `FinAccountServiceImpl.deleteAccount()` | ç§‘ç›®æœ‰å­ç§‘ç›® |
| "è¯¥ç§‘ç›®å·²è¢«ä½¿ç”¨ï¼Œæ— æ³•åˆ é™¤" | `FinAccountServiceImpl.deleteAccount()` | ç§‘ç›®å·²è¢«å‡­è¯ä½¿ç”¨ |
| "ç§‘ç›®ä»£ç å·²å­˜åœ¨ï¼šXXX" | `FinAccountServiceImpl.addAccount()` | ç§‘ç›®ä»£ç é‡å¤ |
| "ä¸šåŠ¡å®ä½“ç±»å‹ä¸åŒ¹é…" | `OwnerValidationServiceImpl.findOwnerById()` | ä¸šåŠ¡å®ä½“ç±»å‹ä¸ä¸€è‡´ |

#### 4.4.2.3 å¼‚å¸¸å¤„ç†è§„èŒƒ

**è§„èŒƒ1ï¼šå¼‚å¸¸æ¶ˆæ¯æ ¼å¼**
- ä½¿ç”¨ä¸­æ–‡æè¿°ï¼Œæ¸…æ™°æ˜ç¡®
- åŒ…å«å…³é”®ä¿¡æ¯ï¼ˆå¦‚IDã€é‡‘é¢ã€ç§‘ç›®åç§°ç­‰ï¼‰
- æ ¼å¼ç»Ÿä¸€ï¼š`"æ“ä½œå¯¹è±¡ + é”™è¯¯åŸå›  + è¯¦ç»†ä¿¡æ¯"`

**è§„èŒƒ2ï¼šå¼‚å¸¸æŠ›å‡ºæ—¶æœº**
- **å‰ç½®æ ¡éªŒ**ï¼šåœ¨ä¸šåŠ¡é€»è¾‘æ‰§è¡Œå‰è¿›è¡Œæ ¡éªŒï¼Œå°½æ—©å‘ç°é—®é¢˜
- **æ•°æ®ä¸€è‡´æ€§**ï¼šåœ¨æ•°æ®ä¸ä¸€è‡´æ—¶ç«‹å³æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…è„æ•°æ®
- **çŠ¶æ€æ£€æŸ¥**ï¼šåœ¨çŠ¶æ€æµè½¬ä¸ç¬¦åˆè§„åˆ™æ—¶æŠ›å‡ºå¼‚å¸¸

**è§„èŒƒ3ï¼šå¼‚å¸¸ä¼ æ’­**
```java
// Service å±‚æŠ›å‡ºå¼‚å¸¸
@Transactional(rollbackFor = Exception.class)
public void saveVoucher(FinTransaction transaction) {
    if (condition) {
        throw new BusinessException("é”™è¯¯æ¶ˆæ¯"); // ç›´æ¥æŠ›å‡º
    }
}

// Controller å±‚æ•è·å¼‚å¸¸ï¼ˆç”±å…¨å±€å¼‚å¸¸å¤„ç†å™¨ç»Ÿä¸€å¤„ç†ï¼‰
@RestControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(BusinessException.class)
    public Result handleBusinessException(BusinessException e) {
        return Result.error(e.getCode(), e.getMessage());
    }
}
```

**è§„èŒƒ4ï¼šå¼‚å¸¸ä¸äº‹åŠ¡**
- ä¸šåŠ¡å¼‚å¸¸ä¼šè§¦å‘äº‹åŠ¡å›æ»šï¼ˆ`rollbackFor = Exception.class`ï¼‰
- ç¡®ä¿å¼‚å¸¸å‘ç”Ÿåæ•°æ®ä¸ä¼šéƒ¨åˆ†æäº¤
- ä¿è¯æ•°æ®ä¸€è‡´æ€§

### 4.4.3 æ•°æ®æµå›¾

#### 4.4.3.1 å‡­è¯å½•å…¥æ•°æ®æµ

```
å‰ç«¯ DTO
  â†“
Controller å±‚ï¼ˆæ¥æ”¶ DTOï¼‰
  â†“
Service å±‚ï¼ˆDTO â†’ Entityï¼‰
  â”œâ”€ ä¸šåŠ¡æ ¡éªŒ
  â”œâ”€ æ•°æ®è½¬æ¢
  â””â”€ Entity å¯¹è±¡
  â†“
Mapper å±‚ï¼ˆEntity â†’ SQLï¼‰
  â”œâ”€ æ’å…¥ä¸»è¡¨ï¼ˆfin_transactionï¼‰
  â””â”€ æ’å…¥å­è¡¨ï¼ˆfin_splitï¼‰
  â†“
æ•°æ®åº“
```

#### 4.4.3.2 æŠ¥è¡¨ç”Ÿæˆæ•°æ®æµ

```
Controller å±‚ï¼ˆè¯·æ±‚å‚æ•°ï¼šreportDateï¼‰
  â†“
ReportService
  â†“
AccountingServiceï¼ˆè®¡ç®—ä½™é¢ï¼‰
  â”œâ”€ æŸ¥è¯¢ç§‘ç›®ï¼ˆEntityï¼‰
  â”œâ”€ æŸ¥è¯¢åˆ†å½•ï¼ˆEntityï¼‰
  â””â”€ è®¡ç®—ä½™é¢ï¼ˆEntity â†’ DTOï¼‰
  â†“
ReportServiceï¼ˆç»„è£…æŠ¥è¡¨ï¼‰
  â”œâ”€ Entity â†’ DTO è½¬æ¢
  â”œâ”€ åˆ†ç±»æ±‡æ€»
  â””â”€ ç”ŸæˆæŠ¥è¡¨ DTO
  â†“
Controller å±‚ï¼ˆè¿”å› DTOï¼‰
  â†“
å‰ç«¯å±•ç¤º
```

## 4.5 ä¸šåŠ¡ API æ¥å£æ–‡æ¡£

### 4.5.1 API æ¥å£æ€»è§ˆ

ç³»ç»Ÿæä¾› RESTful API æ¥å£ï¼Œé‡‡ç”¨ç»Ÿä¸€çš„å“åº”æ ¼å¼ `R<T>`ï¼Œæ‰€æœ‰æ¥å£å‡éœ€è¦ JWT Token è®¤è¯ï¼ˆç™»å½•æ¥å£é™¤å¤–ï¼‰ã€‚

**åŸºç¡€è·¯å¾„**ï¼š
- è´¢åŠ¡æ¨¡å—ï¼š`/finance`
- æŠ¥è¡¨æ¨¡å—ï¼š`/reports`
- å•æ®æ¨¡å—ï¼š`/finance/document`
- è®¤è¯æ¨¡å—ï¼š`/admin/auth`

**ç»Ÿä¸€å“åº”æ ¼å¼**ï¼š
```json
{
  "code": 200,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": {}
}
```

---

### 4.5.2 å‡­è¯ç®¡ç† API

#### ğŸ“‹ å‡­è¯ CRUD æ¥å£

| æ¥å£è·¯å¾„ | è¯·æ±‚æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° | è¿”å›ç±»å‹ |
|---------|---------|---------|---------|---------|
| `/finance/voucher/add` | `POST` | å½•å…¥å‡­è¯ | `FinTransaction` (Body) | `R<String>` |
| `/finance/voucher/update` | `PUT` | æ›´æ–°å‡­è¯ | `FinTransaction` (Body) | `R<String>` |
| `/finance/voucher/delete/{transId}` | `DELETE` | åˆ é™¤å‡­è¯ | `transId` (Path) | `R<String>` |
| `/finance/voucher/{transId}` | `GET` | æŸ¥è¯¢å‡­è¯è¯¦æƒ… | `transId` (Path) | `R<FinTransaction>` |
| `/finance/voucher/query` | `POST` | åˆ†é¡µæŸ¥è¯¢å‡­è¯ | `VoucherQueryDTO` (Body) | `R<IPage<FinTransaction>>` |

#### ğŸ” å‡­è¯æ“ä½œæ¥å£

| æ¥å£è·¯å¾„ | è¯·æ±‚æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° | è¿”å›ç±»å‹ |
|---------|---------|---------|---------|---------|
| `/finance/voucher/audit/{transId}` | `POST` | å®¡æ ¸å‡­è¯ | `transId` (Path) | `R<String>` |
| `/finance/voucher/generateNo` | `GET` | ç”Ÿæˆå‡­è¯å· | æ—  | `R<String>` |

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```http
POST /finance/voucher/add
Content-Type: application/json

{
  "transDate": "2024-12-01",
  "description": "æŠ¥é”€è´¹ç”¨",
  "status": 0,
  "splits": [
    {
      "accountId": 1001,
      "direction": "DEBIT",
      "amount": 1000.00,
      "memo": "å·®æ—…è´¹"
    },
    {
      "accountId": 1002,
      "direction": "CREDIT",
      "amount": 1000.00,
      "memo": "é“¶è¡Œå­˜æ¬¾"
    }
  ]
}
```

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 200,
  "msg": "å‡­è¯å½•å…¥æˆåŠŸ",
  "data": null
}
```

---

### 4.5.3 ç§‘ç›®ç®¡ç† API

#### ğŸŒ³ ç§‘ç›®æ ‘å½¢ç»“æ„æ¥å£

| æ¥å£è·¯å¾„ | è¯·æ±‚æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° | è¿”å›ç±»å‹ |
|---------|---------|---------|---------|---------|
| `/finance/account/tree` | `GET` | è·å–ç§‘ç›®æ ‘å½¢ç»“æ„ | æ—  | `R<List<AccountDTO>>` |
| `/finance/account/children/{parentId}` | `GET` | è·å–å­ç§‘ç›®åˆ—è¡¨ | `parentId` (Path) | `R<List<FinAccount>>` |
| `/finance/account/{accountId}/path` | `GET` | è·å–ç§‘ç›®å±‚çº§è·¯å¾„ | `accountId` (Path) | `R<String>` |

#### ğŸ“ ç§‘ç›® CRUD æ¥å£

| æ¥å£è·¯å¾„ | è¯·æ±‚æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° | è¿”å›ç±»å‹ |
|---------|---------|---------|---------|---------|
| `/finance/account/add` | `POST` | æ·»åŠ ç§‘ç›® | `FinAccount` (Body) | `R<String>` |
| `/finance/account/update` | `PUT` | æ›´æ–°ç§‘ç›® | `FinAccount` (Body) | `R<String>` |
| `/finance/account/delete/{accountId}` | `DELETE` | åˆ é™¤ç§‘ç›® | `accountId` (Path) | `R<String>` |
| `/finance/account/{accountId}` | `GET` | æŸ¥è¯¢ç§‘ç›®è¯¦æƒ… | `accountId` (Path) | `R<FinAccount>` |

#### ğŸ” ç§‘ç›®æŸ¥è¯¢æ¥å£

| æ¥å£è·¯å¾„ | è¯·æ±‚æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° | è¿”å›ç±»å‹ |
|---------|---------|---------|---------|---------|
| `/finance/account/{accountId}/isLeaf` | `GET` | åˆ¤æ–­æ˜¯å¦ä¸ºæœ«çº§ç§‘ç›® | `accountId` (Path) | `R<Boolean>` |
| `/finance/account/leaf` | `GET` | è·å–æ‰€æœ‰æœ«çº§ç§‘ç›® | æ—  | `R<List<AccountDTO>>` |

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```http
POST /finance/account/add
Content-Type: application/json

{
  "accountCode": "1001",
  "accountName": "åº“å­˜ç°é‡‘",
  "accountType": "ASSET",
  "parentId": null
}
```

---

### 4.5.4 æ ¸ç®—åŠŸèƒ½ API

#### ğŸ’° ä½™é¢è®¡ç®—æ¥å£

| æ¥å£è·¯å¾„ | è¯·æ±‚æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° | è¿”å›ç±»å‹ |
|---------|---------|---------|---------|---------|
| `/finance/accounting/balance/{accountId}` | `GET` | è®¡ç®—å•ä¸ªç§‘ç›®ä½™é¢ | `accountId` (Path)<br>`date` (Query, å¯é€‰) | `R<AccountBalanceDTO>` |
| `/finance/accounting/balance/all` | `GET` | è®¡ç®—æ‰€æœ‰ç§‘ç›®ä½™é¢ | `date` (Query, å¯é€‰) | `R<List<AccountBalanceDTO>>` |

#### ğŸ“Š è¯•ç®—å¹³è¡¡æ¥å£

| æ¥å£è·¯å¾„ | è¯·æ±‚æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° | è¿”å›ç±»å‹ |
|---------|---------|---------|---------|---------|
| `/finance/accounting/trialBalance` | `GET` | ç”Ÿæˆè¯•ç®—å¹³è¡¡è¡¨ | `startDate` (Query)<br>`endDate` (Query) | `R<List<TrialBalanceDTO>>` |
| `/finance/accounting/verifyBalance` | `GET` | éªŒè¯è¯•ç®—å¹³è¡¡ | `date` (Query, å¯é€‰) | `R<Boolean>` |

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```http
GET /finance/accounting/balance/1001?date=2024-12-01
```

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 200,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": {
    "accountId": 1001,
    "accountCode": "1001",
    "accountName": "åº“å­˜ç°é‡‘",
    "accountType": "ASSET",
    "debitBalance": 50000.00,
    "creditBalance": 20000.00,
    "balance": 30000.00
  }
}
```

---

### 4.5.5 æŠ¥è¡¨åŠŸèƒ½ API

#### ğŸ“ˆ æŠ¥è¡¨ç”Ÿæˆæ¥å£

| æ¥å£è·¯å¾„ | è¯·æ±‚æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° | è¿”å›ç±»å‹ |
|---------|---------|---------|---------|---------|
| `/finance/report/balanceSheet` | `GET` | ç”Ÿæˆèµ„äº§è´Ÿå€ºè¡¨ | `date` (Query, å¯é€‰) | `R<BalanceSheetDTO>` |
| `/finance/report/cashFlow` | `GET` | ç”Ÿæˆç°é‡‘æµé‡è¡¨ | `startDate` (Query)<br>`endDate` (Query) | `R<CashFlowDTO>` |

#### ğŸ“¥ æŠ¥è¡¨å¯¼å‡ºæ¥å£

| æ¥å£è·¯å¾„ | è¯·æ±‚æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° | è¿”å›ç±»å‹ |
|---------|---------|---------|---------|---------|
| `/finance/report/balance-sheet/export` | `GET` | å¯¼å‡ºèµ„äº§è´Ÿå€ºè¡¨åˆ°Excel | `date` (Query, å¯é€‰) | `æ–‡ä»¶æµ` |
| `/finance/report/trial-balance/export` | `GET` | å¯¼å‡ºè¯•ç®—å¹³è¡¡è¡¨åˆ°Excel | `startDate` (Query)<br>`endDate` (Query) | `æ–‡ä»¶æµ` |
| `/finance/report/cash-flow/export` | `GET` | å¯¼å‡ºç°é‡‘æµé‡è¡¨åˆ°Excel | `startDate` (Query)<br>`endDate` (Query) | `æ–‡ä»¶æµ` |
| `/reports/cash-flow/export` | `GET` | å¯¼å‡ºç°é‡‘æµé‡è¡¨ï¼ˆæŠ¥è¡¨æ¨¡å—ï¼‰ | `startDate` (Query)<br>`endDate` (Query) | `æ–‡ä»¶æµ` |

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```http
GET /finance/report/balanceSheet?date=2024-12-01
```

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 200,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": {
    "reportDate": "2024-12-01",
    "assets": [
      {
        "accountCode": "1001",
        "accountName": "åº“å­˜ç°é‡‘",
        "amount": 30000.00
      }
    ],
    "totalAssets": 500000.00,
    "liabilities": [],
    "totalLiabilities": 200000.00,
    "equity": [],
    "totalEquity": 300000.00,
    "totalLiabilitiesAndEquity": 500000.00
  }
}
```

---

### 4.5.6 ä¸šåŠ¡å•æ®ç®¡ç† API

#### ğŸ“„ å‘ç¥¨ç®¡ç†æ¥å£

| æ¥å£è·¯å¾„ | è¯·æ±‚æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° | è¿”å›ç±»å‹ |
|---------|---------|---------|---------|---------|
| `/finance/document/invoice/list` | `GET` | è·å–å‘ç¥¨åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰ | `pageNum` (Query, é»˜è®¤1)<br>`pageSize` (Query, é»˜è®¤10) | `R<IPage<Invoice>>` |
| `/finance/document/invoice/create` | `POST` | åˆ›å»ºå‘ç¥¨ | `Invoice` (Body) | `R<Invoice>` |
| `/finance/document/invoice/update` | `PUT` | æ›´æ–°å‘ç¥¨ | `Invoice` (Body) | `R<Invoice>` |
| `/finance/document/invoice/delete/{invoiceId}` | `DELETE` | åˆ é™¤å‘ç¥¨ | `invoiceId` (Path) | `R<String>` |
| `/finance/document/invoice/{invoiceId}` | `GET` | æŸ¥è¯¢å‘ç¥¨è¯¦æƒ… | `invoiceId` (Path) | `R<Invoice>` |
| `/finance/document/invoice/validate/{invoiceId}` | `POST` | å®¡æ ¸å‘ç¥¨ | `invoiceId` (Path) | `R<String>` |
| `/finance/document/invoice/post/{invoiceId}` | `POST` | è¿‡è´¦å‘ç¥¨ | `invoiceId` (Path) | `R<String>` |
| `/finance/document/invoice/cancel/{invoiceId}` | `POST` | ä½œåºŸå‘ç¥¨ | `invoiceId` (Path) | `R<String>` |
| `/finance/document/invoice/unpaid/{customerId}` | `GET` | è·å–å®¢æˆ·æœªç»“æ¸…å‘ç¥¨ | `customerId` (Path) | `R<List<Invoice>>` |

#### ğŸ“‹ è´¦å•ç®¡ç†æ¥å£

| æ¥å£è·¯å¾„ | è¯·æ±‚æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° | è¿”å›ç±»å‹ |
|---------|---------|---------|---------|---------|
| `/finance/document/bill/list` | `GET` | è·å–è´¦å•åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰ | `pageNum` (Query, é»˜è®¤1)<br>`pageSize` (Query, é»˜è®¤10) | `R<IPage<Bill>>` |
| `/finance/document/bill/create` | `POST` | åˆ›å»ºè´¦å• | `Bill` (Body) | `R<Bill>` |
| `/finance/document/bill/update` | `PUT` | æ›´æ–°è´¦å• | `Bill` (Body) | `R<Bill>` |
| `/finance/document/bill/delete/{billId}` | `DELETE` | åˆ é™¤è´¦å• | `billId` (Path) | `R<String>` |
| `/finance/document/bill/{billId}` | `GET` | æŸ¥è¯¢è´¦å•è¯¦æƒ… | `billId` (Path) | `R<Bill>` |
| `/finance/document/bill/validate/{billId}` | `POST` | å®¡æ ¸è´¦å• | `billId` (Path) | `R<String>` |
| `/finance/document/bill/post/{billId}` | `POST` | è¿‡è´¦è´¦å• | `billId` (Path) | `R<String>` |
| `/finance/document/bill/cancel/{billId}` | `POST` | ä½œåºŸè´¦å• | `billId` (Path) | `R<String>` |
| `/finance/document/bill/unpaid/{vendorId}` | `GET` | è·å–ä¾›åº”å•†æœªç»“æ¸…è´¦å• | `vendorId` (Path) | `R<List<Bill>>` |

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```http
POST /finance/document/invoice/create
Content-Type: application/json

{
  "invoiceNo": "INV20241201001",
  "customerId": 1,
  "invoiceDate": "2024-12-01",
  "totalAmount": 10000.00,
  "netAmount": 8849.56,
  "taxAmount": 1150.44,
  "items": [
    {
      "description": "å•†å“A",
      "quantity": 10,
      "unitPrice": 884.96,
      "amount": 8849.60
    }
  ]
}
```

---

### 4.5.7 ä¸šåŠ¡å®ä½“ç®¡ç† API

#### ğŸ‘¥ å¾€æ¥å•ä½ç®¡ç†æ¥å£

| æ¥å£è·¯å¾„ | è¯·æ±‚æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° | è¿”å›ç±»å‹ |
|---------|---------|---------|---------|---------|
| `/finance/document/owner/list` | `GET` | è·å–ä¸šåŠ¡å®ä½“åˆ—è¡¨ | `ownerType` (Query, å¯é€‰) | `R<List<Owner>>` |
| `/finance/document/owner/create` | `POST` | åˆ›å»ºä¸šåŠ¡å®ä½“ | `Owner` (Body) | `R<Owner>` |
| `/finance/document/owner/update` | `PUT` | æ›´æ–°ä¸šåŠ¡å®ä½“ | `Owner` (Body) | `R<Owner>` |
| `/finance/document/owner/delete/{ownerId}` | `DELETE` | åˆ é™¤ä¸šåŠ¡å®ä½“ | `ownerId` (Path) | `R<String>` |
| `/finance/document/owner/{ownerId}` | `GET` | æŸ¥è¯¢ä¸šåŠ¡å®ä½“è¯¦æƒ… | `ownerId` (Path) | `R<Owner>` |
| `/finance/owner/list` | `GET` | è·å–å¾€æ¥å•ä½åˆ—è¡¨ï¼ˆä¸‹æ‹‰é€‰æ‹©ï¼‰ | `category` (Query, å¯é€‰) | `R<List<PartnerDTO>>` |

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```http
POST /finance/document/owner/create
Content-Type: application/json

{
  "ownerType": "CUSTOMER",
  "name": "ABCå…¬å¸",
  "code": "CUST001",
  "accountId": 1121,
  "enabled": true
}
```

---

### 4.5.8 æ”¯ä»˜å¤„ç† API

#### ğŸ’³ æ”¯ä»˜å¤„ç†æ¥å£

| æ¥å£è·¯å¾„ | è¯·æ±‚æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° | è¿”å›ç±»å‹ |
|---------|---------|---------|---------|---------|
| `/finance/payment/customer` | `POST` | å¤„ç†å®¢æˆ·ä»˜æ¬¾ | `ownerId` (Query)<br>`amount` (Query)<br>`accountId` (Query) | `R<Map<String, Object>>` |
| `/finance/payment/vendor` | `POST` | å¤„ç†ä¾›åº”å•†ä»˜æ¬¾ | `ownerId` (Query)<br>`amount` (Query)<br>`accountId` (Query) | `R<Map<String, Object>>` |
| `/finance/payment/post/{paymentId}` | `POST` | æ”¯ä»˜è¿‡è´¦ | `paymentId` (Path) | `R<String>` |
| `/finance/payment/unpost/{paymentId}` | `POST` | æ’¤é”€æ”¯ä»˜è¿‡è´¦ | `paymentId` (Path) | `R<String>` |
| `/finance/payment/unpaid/{ownerId}` | `GET` | è·å–å®ä½“æœªç»“æ¸…é‡‘é¢ | `ownerId` (Path) | `R<BigDecimal>` |

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```http
POST /finance/payment/customer?ownerId=1&amount=5000.00&accountId=1002
```

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 200,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": {
    "payment": {
      "paymentId": 1,
      "ownerId": 1,
      "amount": 5000.00,
      "status": "DRAFT"
    },
    "allocations": [
      {
        "invoiceId": 1,
        "allocatedAmount": 5000.00
      }
    ]
  }
}
```

---

### 4.5.9 æŠ¥é”€å•ç®¡ç† API

#### ğŸ§¾ ä¸šåŠ¡æŠ¥é”€å•æ¥å£ï¼ˆBizExpenseClaimï¼‰

| æ¥å£è·¯å¾„ | è¯·æ±‚æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° | è¿”å›ç±»å‹ |
|---------|---------|---------|---------|---------|
| `/finance/biz-expense-claim/save` | `POST` | ä¿å­˜æŠ¥é”€å•ï¼ˆæ–°å¢/æ›´æ–°ï¼‰ | `BizExpenseClaim` (Body) | `R<BizExpenseClaim>` |
| `/finance/biz-expense-claim/update` | `PUT` | æ›´æ–°æŠ¥é”€å• | `BizExpenseClaim` (Body) | `R<BizExpenseClaim>` |
| `/finance/biz-expense-claim/save-and-post` | `POST` | ä¿å­˜å¹¶è¿‡è´¦æŠ¥é”€å• | `BizExpenseClaim` (Body) | `R<FinTransaction>` |
| `/finance/biz-expense-claim/post/{claimId}` | `POST` | æŠ¥é”€å•è¿‡è´¦ | `claimId` (Path) | `R<FinTransaction>` |
| `/finance/biz-expense-claim/{claimId}` | `GET` | æŸ¥è¯¢æŠ¥é”€å•è¯¦æƒ… | `claimId` (Path) | `R<BizExpenseClaim>` |
| `/finance/biz-expense-claim/list` | `POST` | æŸ¥è¯¢æŠ¥é”€å•åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰ | `Map<String, Object>` (Body) | `R<IPage<BizExpenseClaim>>` |

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```http
POST /finance/biz-expense-claim/save
Content-Type: application/json

{
  "claimDate": "2024-12-01",
  "applicantId": 1,
  "creditAccountId": 1002,
  "totalAmount": 1000.00,
  "details": [
    {
      "debitAccountId": 6601,
      "amount": 500.00,
      "description": "å·®æ—…è´¹"
    },
    {
      "debitAccountId": 6602,
      "amount": 500.00,
      "description": "é¤è´¹"
    }
  ]
}
```

#### ğŸ“ å‘˜å·¥æŠ¥é”€æ¥å£ï¼ˆExpenseClaimï¼‰

| æ¥å£è·¯å¾„ | è¯·æ±‚æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° | è¿”å›ç±»å‹ |
|---------|---------|---------|---------|---------|
| `/finance/expense-claim/submit` | `POST` | æäº¤æŠ¥é”€å• | `ExpenseClaim` (Body) | `R<String>` |
| `/finance/expense-claim/approve/{claimId}` | `POST` | å®¡æ‰¹æŠ¥é”€å• | `claimId` (Path)<br>`approverId` (Query)<br>`approved` (Query)<br>`comment` (Query, å¯é€‰) | `R<String>` |
| `/finance/expense-claim/post/{claimId}` | `POST` | è¿‡è´¦æŠ¥é”€å• | `claimId` (Path) | `R<String>` |

---

### 4.5.10 æ”¶ä»˜æ¬¾å•ç®¡ç† API

#### ğŸ’° æ”¶ä»˜æ¬¾å•æ¥å£

| æ¥å£è·¯å¾„ | è¯·æ±‚æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° | è¿”å›ç±»å‹ |
|---------|---------|---------|---------|---------|
| `/finance/biz-receipt-payment/save` | `POST` | ä¿å­˜æ”¶ä»˜æ¬¾å• | `BizReceiptPayment` (Body) | `R<BizReceiptPayment>` |
| `/finance/biz-receipt-payment/save-and-post` | `POST` | ä¿å­˜å¹¶è¿‡è´¦æ”¶ä»˜æ¬¾å• | `BizReceiptPayment` (Body) | `R<BizReceiptPayment>` |
| `/finance/biz-receipt-payment/list` | `GET` | æŸ¥è¯¢æ”¶ä»˜æ¬¾å•åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰ | `pageNum` (Query, é»˜è®¤1)<br>`pageSize` (Query, é»˜è®¤10)<br>`type` (Query, å¯é€‰)<br>`status` (Query, å¯é€‰) | `R<IPage<BizReceiptPayment>>` |
| `/finance/biz-receipt-payment/{id}` | `GET` | è·å–æ”¶ä»˜æ¬¾å•è¯¦æƒ… | `id` (Path) | `AjaxResult<BizReceiptPayment>` |

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```http
POST /finance/biz-receipt-payment/save
Content-Type: application/json

{
  "type": "RECEIPT",
  "date": "2024-12-01",
  "ownerId": 1,
  "partnerName": "ABCå…¬å¸",
  "accountId": 1002,
  "amount": 10000.00,
  "remark": "è´§æ¬¾"
}
```

---

### 4.5.11 å•æ®è¿‡è´¦ API

#### ğŸ“¤ å•æ®è¿‡è´¦æ¥å£

| æ¥å£è·¯å¾„ | è¯·æ±‚æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° | è¿”å›ç±»å‹ |
|---------|---------|---------|---------|---------|
| `/finance/invoice/post/{invoiceId}` | `POST` | å‘ç¥¨è¿‡è´¦ | `invoiceId` (Path) | `R<String>` |
| `/finance/bill/post/{billId}` | `POST` | è´¦å•è¿‡è´¦ | `billId` (Path) | `R<String>` |
| `/finance/creditnote/post/{creditNoteId}` | `POST` | å†²é”€å•æ®è¿‡è´¦ | `creditNoteId` (Path) | `R<String>` |
| `/finance/invoice/unpost/{invoiceId}` | `POST` | æ’¤é”€å‘ç¥¨è¿‡è´¦ | `invoiceId` (Path) | `R<String>` |
| `/finance/bill/unpost/{billId}` | `POST` | æ’¤é”€è´¦å•è¿‡è´¦ | `billId` (Path) | `R<String>` |
| `/finance/creditnote/unpost/{creditNoteId}` | `POST` | æ’¤é”€å†²é”€å•æ®è¿‡è´¦ | `creditNoteId` (Path) | `R<String>` |

---

### 4.5.12 é‚®å¯„è¿½è¸ª API

#### ğŸ“® é‚®å¯„è¿½è¸ªæ¥å£

| æ¥å£è·¯å¾„ | è¯·æ±‚æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° | è¿”å›ç±»å‹ |
|---------|---------|---------|---------|---------|
| `/finance/invoice/mark-as-sent/{invoiceId}` | `POST` | æ ‡è®°å‘ç¥¨ä¸ºå·²é‚®å¯„ | `invoiceId` (Path)<br>`trackingNo` (Query) | `R<String>` |

---

### 4.5.13 è®¤è¯æˆæƒ API

#### ğŸ” è®¤è¯æ¥å£

| æ¥å£è·¯å¾„ | è¯·æ±‚æ–¹æ³• | åŠŸèƒ½æè¿° | è¯·æ±‚å‚æ•° | è¿”å›ç±»å‹ |
|---------|---------|---------|---------|---------|
| `/admin/auth/login` | `POST` | ç”¨æˆ·ç™»å½• | `LoginDTO` (Body) | `R<Map<String, Object>>` |
| `/admin/auth/info` | `GET` | è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ | æ— ï¼ˆéœ€è¦Tokenï¼‰ | `R<Map<String, Object>>` |

**è¯·æ±‚ç¤ºä¾‹**ï¼š

```http
POST /admin/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "123456"
}
```

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
  "code": 200,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "permissions": [
      "finance:voucher:add",
      "finance:voucher:update",
      "finance:account:add"
    ]
  }
}
```

---

### 4.5.14 API ä½¿ç”¨è¯´æ˜

#### ğŸ”‘ è®¤è¯æ–¹å¼

æ‰€æœ‰æ¥å£ï¼ˆé™¤ç™»å½•æ¥å£å¤–ï¼‰éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ JWT Tokenï¼š

```http
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### ğŸ“ åˆ†é¡µå‚æ•°è¯´æ˜

åˆ†é¡µæŸ¥è¯¢æ¥å£ç»Ÿä¸€ä½¿ç”¨ä»¥ä¸‹å‚æ•°ï¼š

| å‚æ•°å | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|-------|------|------|--------|------|
| `pageNum` | Integer | å¦ | 1 | é¡µç  |
| `pageSize` | Integer | å¦ | 10 | æ¯é¡µå¤§å° |

**åˆ†é¡µå“åº”æ ¼å¼**ï¼š

```json
{
  "code": 200,
  "msg": "æ“ä½œæˆåŠŸ",
  "data": {
    "records": [],
    "total": 100,
    "size": 10,
    "current": 1,
    "pages": 10
  }
}
```

#### ğŸ“… æ—¥æœŸæ ¼å¼è¯´æ˜

æ‰€æœ‰æ—¥æœŸå‚æ•°ç»Ÿä¸€ä½¿ç”¨ `yyyy-MM-dd` æ ¼å¼ï¼Œä¾‹å¦‚ï¼š`2024-12-01`

#### âš ï¸ é”™è¯¯å“åº”æ ¼å¼

```json
{
  "code": 500,
  "msg": "é”™è¯¯ä¿¡æ¯",
  "data": null
}
```

#### ğŸ¯ çŠ¶æ€ç è¯´æ˜

| çŠ¶æ€ç  | è¯´æ˜ |
|-------|------|
| 200 | æ“ä½œæˆåŠŸ |
| 400 | è¯·æ±‚å‚æ•°é”™è¯¯ |
| 401 | æœªç™»å½•æˆ–Tokenè¿‡æœŸ |
| 403 | æ— æƒé™è®¿é—® |
| 500 | æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ |

---

## 4.6 æ€»ç»“

### 4.6.1 æ¶æ„ä¼˜åŠ¿

1. **åˆ†å±‚æ¸…æ™°**ï¼šæ¥å£ä¸å®ç°åˆ†ç¦»ï¼ŒèŒè´£æ˜ç¡®
2. **äº‹åŠ¡ä¿éšœ**ï¼šå®Œå–„çš„äº‹åŠ¡ç®¡ç†æœºåˆ¶ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
3. **ä¸šåŠ¡è§„åˆ™é›†ä¸­**ï¼šæ ¸å¿ƒä¸šåŠ¡è§„åˆ™é›†ä¸­åœ¨ Service å±‚ï¼Œæ˜“äºç»´æŠ¤
4. **å¼‚å¸¸è§„èŒƒç»Ÿä¸€**ï¼šç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œä¾¿äºé”™è¯¯å®šä½å’Œå¤„ç†
5. **API è®¾è®¡è§„èŒƒ**ï¼šRESTful é£æ ¼ï¼Œç»Ÿä¸€çš„å“åº”æ ¼å¼å’Œé”™è¯¯å¤„ç†

### 4.6.2 å¾…ä¼˜åŒ–ç‚¹

1. **å¹¶å‘æ§åˆ¶**ï¼šå‡­è¯å·ç”Ÿæˆç­‰åœºæ™¯éœ€è¦åŠ å¼ºå¹¶å‘æ§åˆ¶
2. **æ€§èƒ½ä¼˜åŒ–**ï¼šæ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–ï¼ˆå·²å®ç°ï¼‰ï¼Œä½†å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–ç¼“å­˜ç­–ç•¥
3. **è®¾è®¡æ¨¡å¼**ï¼šå¯ä»¥è¿›ä¸€æ­¥æŠ½è±¡ç­–ç•¥æ¨¡å¼ï¼Œæé«˜ä»£ç å¯æ‰©å±•æ€§
4. **å¼‚å¸¸åˆ†ç±»**ï¼šå¯ä»¥ç»†åŒ–å¼‚å¸¸ç±»å‹ï¼Œæä¾›æ›´ç²¾ç¡®çš„é”™è¯¯ç 
5. **API æ–‡æ¡£**ï¼šå»ºè®®ä½¿ç”¨ Swagger/OpenAPI è‡ªåŠ¨ç”Ÿæˆ API æ–‡æ¡£

### 4.6.3 æ‰©å±•æ€§è®¾è®¡

1. **æ ¡éªŒè§„åˆ™æ‰©å±•**ï¼šæ ¡éªŒé€»è¾‘ç‹¬ç«‹æ–¹æ³•ï¼Œæ˜“äºæ·»åŠ æ–°è§„åˆ™
2. **æŠ¥è¡¨æ‰©å±•**ï¼šæŠ¥è¡¨ç”Ÿæˆé‡‡ç”¨ç­–ç•¥æ¨¡å¼ï¼Œæ˜“äºæ·»åŠ æ–°æŠ¥è¡¨ç±»å‹
3. **ä¸šåŠ¡å•æ®æ‰©å±•**ï¼šä¸šåŠ¡å•æ®æœåŠ¡é‡‡ç”¨ç»Ÿä¸€æ¥å£ï¼Œæ˜“äºæ·»åŠ æ–°å•æ®ç±»å‹
4. **API ç‰ˆæœ¬æ§åˆ¶**ï¼šå»ºè®®æ·»åŠ  API ç‰ˆæœ¬å·ï¼Œä¾¿äºåç»­å‡çº§ç»´æŠ¤

